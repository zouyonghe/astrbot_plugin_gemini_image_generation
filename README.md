# AstrBot Gemini 图像生成插件 v1.1.0

<div align="center">

![Version](https://img.shields.io/badge/Version-v1.1.0-blue)
![License](https://img.shields.io/badge/License-MIT-orange)

**🎨 强大的 Gemini 图像生成插件，支持智能头像参考和多模式生成**

</div>

## ✨ 特性

### 🖼️ **核心功能**
- **生图模式**: 纯文本到图像生成，支持多种风格和参数
- **改图模式**: 基于参考图像进行修改和风格转换
- **智能头像参考**: 自动获取用户头像和@指定对象头像作为参考
- **多API支持**: 兼容 Google 官方 API 和 OpenAI 兼容格式 API

### 🛡️ **限制/限流**
- **群限制模式**: 支持不限制/白名单/黑名单三种模式
- **群内限流**: 单群在指定周期内的请求次数限制
- **灵活配置**: 群限制和限流可同时启用，实现精细控制
- **防滥用**: 有效防止API滥用和资源浪费

### 🧠 **智能特性**
- **自然语言触发**: 支持"按照我"、"修改"、"@人"等自然语言触发
- **智能优先级**: @用户 > 发言人 > 群头像（暂未实现）
- **降级处理**: 自动处理参数兼容性问题
- **缓存机制**: 避免重复下载头像，提升性能
- **多文件配置**: 支持不同聊天环境的独立配置

### ⚙️ **高级配置**
- **分辨率控制**: 支持 1K、2K、4K 分辨率
- **长宽比调整**: 支持多种常用比例（1:1, 16:9, 4:3, 9:16等）
- **Google 搜索接地**: 实时数据参考生成
- **智能重试**: 自动重试机制，提高成功率
- **超时管理**: 适配框架超时控制

## 📦 安装

### 前置要求
- AstrBot 4.5.0+
- Python 3.8+
- NapCat

### 安装步骤
1. 将插件文件夹放置到 `data/plugins/` 目录下
2. 确保 `astrbot_plugin_gemini_image_generation` 文件夹存在
3. 重启 AstrBot

## 🔧 配置

### 基础配置

在插件配置中设置以下参数：

<img width="1473" height="1386" alt="image" src="https://github.com/user-attachments/assets/0a469eea-c4bb-422b-9541-1eb61784e353" />
<img width="1429" height="902" alt="image" src="https://github.com/user-attachments/assets/637fbfb8-8f93-4e00-960c-353d17a39c55" />



### API 配置

#### Google 官方 API
- **api_type**: `"google"`
- **model**: `"gemini-3-pro-image-preview"` 或其他Gemini图像生成模型
- **无需** 设置 `custom_api_base`

#### OpenAI 兼容 API
- **api_type**: `"openai"`
- **model**: 任何支持的图像生成模型
- **可选** 设置 `custom_api_base`

### 限制/限流设置

#### 群限制模式
- **group_limit_mode**: 群限制模式（none/whitelist/blacklist）
  - `none`: 不限制，所有群都可以使用
  - `whitelist`: 白名单模式，仅允许列表中的群使用
  - `blacklist`: 黑名单模式，禁止列表中的群使用
- **group_limit_list**: 群号列表（字符串形式）
  - 根据群限制模式配置需要生效的群号
  - 在 none 模式下此配置不生效

#### 群内限流
- **enable_rate_limit**: 启用群内限流
  - 开启后对每个群在指定周期内的图像生成请求次数进行限制
- **rate_limit_period**: 限流周期（秒）
  - 每个群的统计周期长度，在此时间窗口内超过最大次数将被拒绝
  - 默认: 60秒
- **max_requests_per_group**: 单群每周期最大请求数
  - 在一个周期内，每个群最多允许触发几次图像生成请求
  - 默认: 5次

**注意**: 群限制模式和群内限流可以同时启用，实现更精细的访问控制。

## 🎯 使用指南

### 基础命令

#### 生图模式
```
/生图 一只可爱的橙色小猫，坐在樱花树下，动漫风格，高清细节
```
```
/生图 未来科技城市，赛博朋克风格，夜景，霓虹灯闪烁
```
```
/生图 森林中的小木屋，早晨阳光透过树叶，写实风格
```
```
/生图 @小王 为基础改成猫娘
```
<img width="1129" height="633" alt="PixPin_2025-11-23_07-14-22" src="https://github.com/user-attachments/assets/f96c8d37-08fd-48b2-b442-4ca8f2a333c4" />

#### 改图模式
```
发送图片 + /改图 把头发改成红色
```
```
发送图片 + /改图 换个背景，改成海边风景
```
```
发送图片 + /改图 @小王 画成动漫风格
```
<img width="1159" height="1458" alt="8749eeb3af9e51ebabe4c82ee04cc1a4" src="https://github.com/user-attachments/assets/55594e40-84b7-43bb-a636-167cd4e980af" />


### 智能头像功能

#### 头像获取优先级
1. **@指定用户** - 最高优先级（获取被@用户的头像）
2. **发言人自己** - 中等优先级（获取发送消息用户的头像）
3. **群头像** - 暂未实现

#### 触发条件

##### 自动获取用户头像
启用 `auto_avatar_reference` 后，以下场景会自动获取头像：

- **个人相关**: "按照我"、"根据我"、"基于我"、"参考我"、"我的头像"
- **修改相关**: "修改"、"改图"、"重做"、"重新"、"调整"、"优化"、"换风格"
- **@用户**: `任何生图/改图命令 +@小王`

##### 条件获取群头像
群头像功能暂未实现，当前版本不会获取群头像作为参考。

#### 使用示例

```bash
# 场景1: 自动获取发言人头像
/生图 按照我生成一个动漫头像
# 结果: 获取发送者头像作为参考
```
```
# 场景2: 获取@用户头像
/改图 @小王 把头发改成蓝色
# 结果: 获取小明头像进行修改
```
```
# 场景3: 群头像功能（暂未实现）
# /生图 根据本群头像设计一个logo
# 结果: 群头像功能暂未实现，不会获取群头像
```
```
# 场景4: 普通生图
/生图 一只可爱的小猫
# 结果: 纯文本生成，不获取任何头像
```
<img width="1145" height="617" alt="PixPin_2025-11-23_07-13-33" src="https://github.com/user-attachments/assets/fc758319-c412-4da0-bf1b-b509203eec5a" />

### 高级功能

#### 快速模式

```bash
# 快速模式预设了最佳分辨率和比例，只需描述想要生成的内容

/快速 头像 商务风格的个人头像        # 内置: 1K分辨率，1:1比例
/快速 海报 赛博朋克游戏宣传          # 内置: 2K分辨率，16:9比例
/快速 壁纸 未来科技城市夜景          # 内置: 4K分辨率，16:9比例
/快速 卡片 简约商务风格名片          # 内置: 1K分辨率，3:2比例
/快速 手机 极简主义手机壁纸          # 内置: 2K分辨率，9:16比例
```

**说明：**
- **头像模式**: 自动使用1K分辨率和1:1比例，适合个人头像
- **海报模式**: 自动使用2K分辨率和16:9比例，适合宣传海报
- **壁纸模式**: 自动使用4K分辨率和16:9比例，适合高清壁纸
- **卡片模式**: 自动使用1K分辨率和3:2比例，适合名片卡片
- **手机模式**: 自动使用2K分辨率和9:16比例，适合手机壁纸

#### 风格转换
```bash
# 发送图片后使用
/换风格 动漫
```
```
/换风格 水彩 梦幻效果
```
```
/换风格 油画 古典艺术风格
```
```
/换风格 像素 8bit复古游戏风格
```

#### 配置管理
```bash
/生图帮助  # 查看当前配置和参数
```

## 🎨 图像生成技巧

### 📝 提示词优化

#### 基础结构
```
[主体描述] + [风格描述] + [细节要求] + [质量词汇]
```

#### 示例
```bash
# 好的提示词
/生图 一只白色波斯猫，蓝色大眼睛，坐在花园里，阳光透过树叶洒下，超高清，杰作，细节丰富
```
```
# 详细描述
/生图 赛博朋克风格的城市夜景，霓虹灯反射在雨后的街道上，飞行汽车穿梭于摩天大楼之间，电影级画质，写实风格
```
```
# 指定艺术风格
/生文 梵高风格的向日葵田，旋转的笔触，鲜艳的色彩，后印象派，油画质感
```

### 🎭 风格关键词

#### 艺术风格
- `动漫风格`、`漫画风格`、`卡通`
- `写实风格`、`超写实`、`照片级`
- `水彩画`、`油画`、`素描`
- `像素艺术`、`8bit`、`复古游戏`
- `赛博朋克`、`蒸汽朋克`、`科幻`
- `中国风`、`和风`、`欧美风`

#### 质量词汇
- `杰作`、`大师作品`、`精品`
- `超高清`、`4K`、`8K`
- `细节丰富`、`精致`、`精细`
- `专业摄影`、`电影级`、`宣传片`

### 📐 参数设置

#### 分辨率选择
- **1K**: 速度快，适合头像、图标
- **2K**: 平衡速度和质量，适合大多数场景
- **4K**: 最高质量，适合壁纸、海报

#### 长宽比
- **1:1**: 头像、图标、正方形图片
- **16:9**: 横向图片、壁纸、海报
- **9:16**: 竖向图片、手机壁纸、封面
- **4:3**: 传统照片比例
- **3:2**: 单反相机比例

## ⚡ 性能优化

### 🚀 提升生成速度

1. **选择合适分辨率**
   - 日常使用: 1K 或 2K
   - 高质量需求: 4K

2. **简化提示词**
   - 避免过于复杂的描述
   - 重点突出主体和风格

3. **合理使用参考图片**
   - 限制参考图片数量（默认最多6张）
   - 选择相关性高的参考图

### 💾 缓存管理

- **头像缓存**: 自动缓存用户头像，避免重复下载
- **智能更新**: 头像变化时自动更新缓存
- **定期清理**: 可配置自动清理过期缓存

## 🔍 故障排除

### 常见问题

#### 🔑 API相关

**问题**: 生成失败，提示API错误
```
❌ 图像生成失败: API只返回了文本响应。请检查模型名称是否正确
```

**解决方案**:
- 检查API密钥是否有效
- 确认模型支持图像生成（如: gemini-3-pro-image-preview）
- 检查API额度是否充足

**问题**: 生成时间过长
```
❌ 图像生成时间过长，超出了框架限制
```

**解决方案**:
- 使用较低的分辨率（1K）
- 简化提示词
- 检查网络连接
- astrbot本体的配置文件增加工具超时时间（使用gemini-3-pro-image-preview推荐100s以上）

#### 🖼️ 头像功能

**问题**: 无法获取头像

**解决方案**:
- 确认使用的是NapCat平台（aiocqhttp）
- 检查NapCat是否正常运行

### 📊 状态检查

```bash
/生图帮助  # 查看当前配置和参数说明
```

#### 检查插件状态
- 确认插件文件夹名正确
- 检查配置文件是否存在
- 开启详细日志开关，查看控制台日志获取详细错误信息

## 🤝 贡献指南

欢迎提交 Issue 和 Pull Request！

### 🐛 报告问题
- 使用Issues提交bug报告
- 提供详细的错误信息和日志
- 说明复现步骤

### 💡 功能建议
- 在Issues中提出功能建议
- 详细描述期望的功能
- 说明使用场景

### 🔧 代码贡献
1. Fork 本仓库
2. 创建功能分支
3. 提交代码更改
4. 发起 Pull Request

## 📄 许可证

本项目采用 MIT 许可证 - 详见 [LICENSE](LICENSE) 文件

## 🙏 致谢

- [AstrBot](https://docs.astrbot.app/) - 强大的机器人框架
- [Google Gemini API](https://ai.google.dev/) - 强大的多模态AI
- [NapCat](https://napneko.github.io/) - OneBot v11 实现

**特别感谢贡献者**:
- [@exynos967](https://github.com/exynos967) - 访问控制功能和代码优化

## 📞 联系支持

- **项目地址**: [GitHub Repository](https://github.com/piexian/astrbot_plugin_gemini_image_generation)
- **问题反馈**: [Issues](https://github.com/piexian/astrbot_plugin_gemini_image_generation/issues)

---

<div align="center">

**如果这个插件对你有帮助，请给个 ⭐ Star 支持一下！**

</div>
