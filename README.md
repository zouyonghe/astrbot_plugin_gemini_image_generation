# AstrBot Gemini 图像生成插件

<div align="center">

![AstrBot](https://img.shields.io/badge/AstrBot-Plugin-blue)
![Version](https://img.shields.io/badge/Version-1.0.0-green)
![License](https://img.shields.io/badge/License-MIT-orange)
![Author](https://img.shields.io/badge/Author-piexian-purple)

**🎨 强大的 Gemini 图像生成插件，支持智能头像参考和多模式生成**

</div>

## ✨ 特性

### 🖼️ **核心功能**
- **生图模式**: 纯文本到图像生成，支持多种风格和参数
- **改图模式**: 基于参考图像进行修改和风格转换
- **智能头像参考**: 自动获取用户头像和@指定对象头像作为参考
- **多API支持**: 兼容 Google 官方 API 和 OpenAI 兼容格式 API

### 🧠 **智能特性**
- **自然语言触发**: 支持"按照我"、"修改"、"@人"等自然语言触发
- **智能优先级**: @用户 > 发言人 > 群头像（条件触发）
- **降级处理**: 自动处理参数兼容性问题
- **缓存机制**: 避免重复下载头像，提升性能
- **多文件配置**: 支持不同聊天环境的独立配置

### ⚙️ **高级配置**
- **分辨率控制**: 支持 1K、2K、4K 分辨率
- **长宽比调整**: 支持多种常用比例（1:1, 16:9, 4:3, 9:16等）
- **Google 搜索接地**: 实时数据参考生成
- **智能重试**: 自动重试机制，提高成功率
- **超时管理**: 适配框架超时控制

## 📦 安装

### 前置要求
- AstrBot 4.5.0+
- Python 3.8+
- NapCat

### 安装步骤
1. 将插件文件夹放置到 `data/plugins/` 目录下
2. 确保 `AstrBot_plugin_gemini_image_generation` 文件夹存在
3. 重启 AstrBot

## 🔧 配置

### 基础配置

在插件配置中设置以下参数：

<img width="1473" height="1386" alt="image" src="https://github.com/user-attachments/assets/0a469eea-c4bb-422b-9541-1eb61784e353" />
<img width="1429" height="902" alt="image" src="https://github.com/user-attachments/assets/637fbfb8-8f93-4e00-960c-353d17a39c55" />



### API 配置

#### Google 官方 API
- **api_type**: `"google"`
- **model**: `"gemini-3-pro-image-preview"` 或其他Gemini图像生成模型
- **无需** 设置 `custom_api_base`

#### OpenAI 兼容 API
- **api_type**: `"openai"`
- **model**: 任何支持的图像生成模型
- **可选** 设置 `custom_api_base`

## 🎯 使用指南

### 基础命令

#### 生图模式
```
/生图 一只可爱的橙色小猫，坐在樱花树下，动漫风格，高清细节
/生图 未来科技城市，赛博朋克风格，夜景，霓虹灯闪烁
/生图 森林中的小木屋，早晨阳光透过树叶，写实风格
/生图 @小王 为基础改成猫娘
```

#### 改图模式
```
发送图片 + /改图 把头发改成红色
发送图片 + /改图 换个背景，改成海边风景
发送图片 + /改图 @小王 画成动漫风格
```

### 智能头像功能

#### 头像获取优先级
1. **@指定用户** - 最高优先级
2. **发言人自己** - 中等优先级

#### 触发条件

##### 自动获取用户头像
启用 `auto_avatar_reference` 后，以下场景会自动获取头像：

- **个人相关**: "按照我"、"根据我"、"基于我"、"参考我"、"我的头像"
- **修改相关**: "修改"、"改图"、"重做"、"重新"、"调整"、"优化"、"换风格"
- **@用户**: `任何生图/改图命令 +@小王`

##### 条件获取群头像
仅在用户**明确提及**群相关关键词时获取：

- "根据群头像"、"参考本群"、"我们群的风格"、"这个群标志"、"群图标"

#### 使用示例

```bash
# 场景1: 自动获取发言人头像
/生图 按照我生成一个动漫头像
# 结果: 获取发送者头像作为参考

# 场景2: 获取@用户头像
/改图 @小王 把头发改成蓝色
# 结果: 获取小明头像进行修改

# 场景3: 条件获取群头像
/生图 根据本群头像设计一个logo
# 结果: 获取群头像作为参考

# 场景4: 普通生图
/生图 一只可爱的小猫
# 结果: 纯文本生成，不获取任何头像
```

### 高级功能

#### 预设模式
```bash
# 快速生成各种类型的图像
/生图 快速模式 头像 生成一个专业的个人头像
/生图 快速模式 海报 制作一个游戏宣传海报
/生图 快速模式 壁纸 生成4K高清桌面壁纸
/生图 快速模式 名片 设计商务风格名片
/生图 快速模式 手机 制作手机壁纸
```

#### 风格转换
```bash
# 发送图片后使用
/改图 换风格 动漫
/改图 换风格 水彩 梦幻效果
/改图 换风格 油画 古典艺术风格
/改图 换风格 像素 8bit复古游戏风格
```

#### 配置管理
```bash
/生图 设置  # 查看当前配置和参数
```

## 🎨 图像生成技巧

### 📝 提示词优化

#### 基础结构
```
[主体描述] + [风格描述] + [细节要求] + [质量词汇]
```

#### 示例
```bash
# 好的提示词
/生图 一只白色波斯猫，蓝色大眼睛，坐在花园里，阳光透过树叶洒下，超高清，杰作，细节丰富

# 详细描述
/生图 赛博朋克风格的城市夜景，霓虹灯反射在雨后的街道上，飞行汽车穿梭于摩天大楼之间，电影级画质，写实风格

# 指定艺术风格
/生文 梵高风格的向日葵田，旋转的笔触，鲜艳的色彩，后印象派，油画质感
```

### 🎭 风格关键词

#### 艺术风格
- `动漫风格`、`漫画风格`、`卡通`
- `写实风格`、`超写实`、`照片级`
- `水彩画`、`油画`、`素描`
- `像素艺术`、`8bit`、`复古游戏`
- `赛博朋克`、`蒸汽朋克`、`科幻`
- `中国风`、`和风`、`欧美风`

#### 质量词汇
- `杰作`、`大师作品`、`精品`
- `超高清`、`4K`、`8K`
- `细节丰富`、`精致`、`精细`
- `专业摄影`、`电影级`、`宣传片`

### 📐 参数设置

#### 分辨率选择
- **1K**: 速度快，适合头像、图标
- **2K**: 平衡速度和质量，适合大多数场景
- **4K**: 最高质量，适合壁纸、海报

#### 长宽比
- **1:1**: 头像、图标、正方形图片
- **16:9**: 横向图片、壁纸、海报
- **9:16**: 竖向图片、手机壁纸、封面
- **4:3**: 传统照片比例
- **3:2**: 单反相机比例

## ⚡ 性能优化

### 🚀 提升生成速度

1. **选择合适分辨率**
   - 日常使用: 1K 或 2K
   - 高质量需求: 4K

2. **简化提示词**
   - 避免过于复杂的描述
   - 重点突出主体和风格

3. **合理使用参考图片**
   - 限制参考图片数量（默认最多6张）
   - 选择相关性高的参考图

### 💾 缓存管理

- **头像缓存**: 自动缓存用户头像，避免重复下载
- **智能更新**: 头像变化时自动更新缓存
- **定期清理**: 可配置自动清理过期缓存

## 🔍 故障排除

### 常见问题

#### 🔑 API相关

**问题**: 生成失败，提示API错误
```
❌ 图像生成失败: API只返回了文本响应。请检查模型名称是否正确
```

**解决方案**:
- 检查API密钥是否有效
- 确认模型支持图像生成（如: gemini-3-pro-image-preview）
- 检查API额度是否充足

**问题**: 生成时间过长
```
❌ 图像生成时间过长，超出了框架限制
```

**解决方案**:
- 使用较低的分辨率（1K）
- 简化提示词
- 检查网络连接
- 本体的配置文件增加工具超时时间（使用gemini-3-pro-image-preview推荐100s以上）

#### 🖼️ 头像功能

**问题**: 无法获取头像

**解决方案**:
- 确认使用的是NapCat平台（aiocqhttp）
- 检查NapCat是否正常运行

### 📊 状态检查

#### 查看当前配置
```bash
/生图 帮助
```

#### 检查插件状态
- 确认插件文件夹名正确
- 检查配置文件是否存在
- 开启详细日志开关，查看控制台日志获取详细错误信息

## 🤝 贡献指南

欢迎提交 Issue 和 Pull Request！

### 🐛 报告问题
- 使用Issues提交bug报告
- 提供详细的错误信息和日志
- 说明复现步骤

### 💡 功能建议
- 在Issues中提出功能建议
- 详细描述期望的功能
- 说明使用场景

### 🔧 代码贡献
1. Fork 本仓库
2. 创建功能分支
3. 提交代码更改
4. 发起 Pull Request

## 📄 许可证

本项目采用 MIT 许可证 - 详见 [LICENSE](LICENSE) 文件

## 🙏 致谢

- [AstrBot](https://docs.astrbot.app/) - 强大的机器人框架
- [Google Gemini API](https://ai.google.dev/) - 强大的多模态AI
- [NapCat](https://napneko.github.io/) - OneBot v11 实现

## 📞 联系支持

- **项目地址**: [GitHub Repository](https://github.com/piexian/AstrBot_plugin_gemini_image_generation)
- **问题反馈**: [Issues](https://github.com/piexian/AstrBot_plugin_gemini_image_generation/issues)

---

<div align="center">

**如果这个插件对你有帮助，请给个 ⭐ Star 支持一下！**

</div>
